name: æ„å»ºè¿·é›¾é€š5 Mint 21 (Ubuntu 22.04)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build_geph5:
    name: ä¸º Ubuntu ${{ matrix.ubuntu_version }} æ„å»ºè¿·é›¾é€š5
    permissions:
      contents: write
    runs-on: ${{ matrix.ubuntu_version }}
    strategy:
      matrix:
        include:
          - ubuntu_version: ubuntu-22.04
            webkit_pkg: libwebkit2gtk-4.0-dev
          # å¦‚æœæœªæ¥ GitHub æ”¯æŒ ubuntu-24.04ï¼Œå¯ä»¥åŠ ï¼š
          # - ubuntu_version: ubuntu-24.04
          #   webkit_pkg: libwebkit2gtk-4.1-dev
    steps:
      - name: åˆ›å»ºæ„å»ºæ–‡ä»¶å¤¹
        run: mkdir ./build

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libgtk-3-dev \
            libappindicator3-dev \
            ${{ matrix.webkit_pkg }} \
            librsvg2-dev \
            libssl-dev \
            patchelf \
            strace \
            libpango1.0-dev \
            libgdk-pixbuf2.0-dev \
            gcc \
            clang \
            g++ \
            zlib1g-dev \
            libmpc-dev \
            libmpfr-dev \
            libgmp-dev \
            build-essential \
            curl \
            pkg-config \
            libsoup-3.0-dev   # ğŸ‘ˆ åŠ è¿™ä¸€è¡Œ

      - name: å®‰è£… Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: å…‹éš† geph5 ä»“åº“
        run: git clone --recurse-submodules https://github.com/geph-official/geph5.git

      - name: æ„å»º geph5-client
        run: |
          cd geph5
          cargo build --release --bin geph5-client
          cp target/release/geph5-client ../build/

      - name: å…‹éš† gephgui-wry ä»“åº“
        run: git clone --recurse-submodules https://github.com/geph-official/gephgui-wry.git

      - name: æ„å»º gephgui
        run: |
          cd gephgui-wry/gephgui
          pnpm install
          pnpm build

      - name: æ„å»º gephgui-wry
        run: |
          cd gephgui-wry
          cargo build --release
          cp target/release/gephgui-wry ../build/

      - name: ç”Ÿæˆ PAC æ–‡ä»¶
        run: |
          echo 'function FindProxyForURL(url, host) { return "SOCKS5 127.0.0.1:9909; DIRECT"; }' > build/pac

      - name: ç”Ÿæˆ VERSION æ–‡ä»¶
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "${{ github.ref_name }}" > build/VERSION
          else
            echo "dev-$(git rev-parse --short HEAD)" > build/VERSION
          fi

      - name: åˆ›å»º TAR å‹ç¼©åŒ…
        run: |
          cd build
          tar -Jcvf ../build_geph5_${{ github.ref_name }}_ubu2204.tar.xz .
          cd ..
          mkdir release && mv build_*.tar.xz release/

      - name: å‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: release/*
          tag: ${{ github.ref_name }}
          overwrite: true
          file_glob: true
